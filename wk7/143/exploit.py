#!/usr/bin/env python3

from pwn import remote
from math import prod


size = [73, 83, 89, 97, 103, 79, 101, 127, 131, 137]


r = remote("host8.dreamhack.games", 13171)


while True:
    remainder = [0 for _ in range(len(size))]
    r.sendlineafter("> ", "1")
    r.sendlineafter("> ", "2")
    r.sendlineafter("> ", "0")

    cnt = 0

    while True:
        r.sendlineafter("> ", "2")
        r.sendlineafter("> ", "1")
        data = r.recvline().decode().strip().split(" ")[1:]
        cnt += 1

        if data.count("7") != 0:
            print(data, "cnt:", cnt)
            idx = data.index("7")
            remainder[idx] = cnt % size[idx]

        if all(x != 0 for x in remainder):
            break

    print("All remainders found:", remainder)

    def crt(remainders, moduli):
        N = prod(moduli)
        total = 0
        for r, m in zip(remainders, moduli):
            Ni = N // m
            inv = pow(Ni, -1, m)
            total += r * Ni * inv
        return total % N, N

    result, N = crt(remainder, size)
    print("Result:", result, "N:", N)

    r.sendlineafter("> ", "2")
    r.sendlineafter("> ", str(result - cnt))
    data = r.recvline().decode().strip().split(" ")
    print(data)
    if data[1:] == ["7"] * 10:
        print("Exploit successful!")
        data = r.recvline().decode().strip().split(" ")
        print(data)
        data = r.recvline().decode().strip().split(" ")
        print(data)
        break
    else:
        print("Nope. Try again")
