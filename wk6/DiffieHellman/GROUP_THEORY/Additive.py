#!/usr/bin/env python3
from pwn import *
from Crypto.Cipher import AES
import hashlib
import json

s = remote("socket.cryptohack.org", "13373")


def decrypt(shared_secret: int, iv: str, ciphertext: str):
    sha1 = hashlib.sha1()
    sha1.update(str(shared_secret).encode("ascii"))
    key = sha1.digest()[:16]

    ciphertext = bytes.fromhex(ciphertext)
    iv = bytes.fromhex(iv)
    cipher = AES.new(key, AES.MODE_CBC, iv)
    plaintext = cipher.decrypt(ciphertext)
    return plaintext

print(s.recvline().decode())
print(s.recvline().decode())
print(s.recvline().decode())

p = 0xffffffffffffffffc90fdaa22168c234c4c6628b80dc1cd129024e088a67cc74020bbea63b139b22514a08798e3404ddef9519b3cd3a431b302b0a6df25f14374fe1356d6d51c245e485b576625e7ec6f44c42e9a637ed6b0bff5cb6f406b7edee386bfb5a899fa5ae9f24117c4b1fe649286651ece45b3dc2007cb8a163bf0598da48361c55d39a69163fa8fd24cf5f83655d23dca3ad961c62f356208552bb9ed529077096966d670c354e4abc9804f1746c08ca237327ffffffffffffffff
g = 0x02
A = 0x9a1f428ebf1217bd3dd5d8a7ba9a66806bb0bda40f4575510d15d207bd11fc1fa93886a4583dade9d96758c6628c229b8f2721ea9d2b9362bc5024646bf081e126a69c40d109128fc4527dcdeda6cc31d583f9b4a575882e52442ca696069e8b748528fab963622acf8d9b07683d39d9f536720f07701aa4b74db424ba21828eba526bfb3351e21ff9844faccf86b71793fcb61f097b4dad75b9a77b60367b3b0310acf13bc02fad6a12468304afcc37efc430f3246609890c1e1c4333e0585a

a = A * pow(g, -1, p)

B = 0x8d79b69390f639501d81bdce911ec9defb0e93d421c02958c8c8dd4e245e61ae861ef9d32aa85dfec628d4046c403199297d6e17f0c9555137b5e8555eb941e8dcfd2fe5e68eecffeb66c6b0de91eb8cf2fd0c0f3f47e0c89779276fa7138e138793020c6b8f834be20a16237900c108f23f872a5f693ca3f93c3fd5a853dfd69518eb4bab9ac2a004d3a11fb21307149e8f2e1d8e1d7c85d604aa0bee335eade60f191f74ee165cd4baa067b96385aa89cbc7722e7426522381fc94ebfa8ef0
shared_secret = (a * B) % p

shared_secret = 781375771286523921682177536065612640494056443200091700967335945135067268298653748996108322420480852844610393628365669516985078401109539826459162980506903623821748901865082257455849415791691881709448350504513673033914283456716068601658189110168981077531264035904750408276794096099693262398008324260587814780721089721047526118391598923434827194939854735798577674170203256314333942485760352085036751905369610326318228197468392759214066509014997981777945415195218141
iv = "c396c71ca5eef7b2b03f359e30de5924"
ciphertext = "5fcf13b8d7e15aed2ac21bbe0ab732e9e75b221a4cba4c90cd63a25d0dda2461d24bc10e7dceffc0fe5a9b4ae00bfaa7"

print(decrypt(shared_secret, iv, ciphertext))
